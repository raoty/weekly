- ## 背景
- 压缩后的gif图片可以减轻存储压力，较少网络带宽消耗，在线图片压缩可以方便用户调整图片大小，然而公网的图片压缩毕竟有安全隐患，考虑搭建一个私服的图片压缩应用。
- ## 原理
- 先研究了下原理 <sup>[1]</sup>
- **1. 压缩尺寸**
- GIF跟一般的静态图片一样，文件大小受尺寸大小影响，尺寸越大的GIF文件越大。压缩尺寸可以有效降低GIF的文件大小。但是一般页面坑位对尺寸的要求都比较严格。减少尺寸使用的较少。
- **2. 减色**
- GIF是连续动态图片，每一帧之间的信息差异小，因此颜色是可以复用的。通常GIF会在文件头储存全局调色盘，包含全部帧会使用到的所有颜色，在播放时通过调用调色盘颜色进行渲染。GIF的颜色越丰富，需要储存的颜色信息就越多，文件也会越大。设计师们使用PS导出GIF时看到的颜色表就是GIF文件头存储的全局调色盘。减少调色盘的颜色可以增大GIF的文件压缩率。但GIF本身就只能存256色已经很少了，减色对GIF图像效果影响比较大，有可能会造成GIF噪点更加明显。因此使用减色对GIF进行压缩有较高风险。而且减色压缩的效率也比较低，减去一半颜色可能只能压缩10%左右。
- **3. 抽帧**
- 帧率指GIF每秒钟依次播放的图片数量，比如：24帧/秒指这张GIF在1秒钟内播放了24张图片，帧率越高GIF的动效会越流畅，但需要储存的图片也会更多，文件会直线增大。一个3秒GIF，帧率为24帧/秒，那么就要储存72张图片；但如果通过抽帧，将帧率降到12帧/秒，那只要储存36张图片就可以了。不过抽帧就像翻页动画书被抽掉间隔页一样，会直接影响动效流畅度，所以如果通过抽帧来压缩的话要让用户保存前先预览，自行把控具体的效果。同时，由于减少帧数，每张图片延迟的时间参数不变的话会导致图片播放过快的情况，需要开发侧进行延时减缓处理。下面两张动图，上面是原图，下面是抽帧处理后没有做延时处理的图，对比来看，下图明显丢失了一些动效细节，比如商品的缓动效果。
- **4. 透明度存储**
- 这种压缩方式是只完整保留GIF的第一帧，排除后续帧没有变化的部分，只存储有变化的像素，避免存储重复的信息。如果图片本身具有较大的静态区域，这种储存方式也许可以有效减小文件大小。
- ## 相关工具
- [AsposeJavaAPI](https://products.aspose.com/imaging/zh-hans/java/compress/gif/)
	- java写的开发工具，特点是支持的格式很多，功能也较强大，性能不太了解，缺点是收费
- [gifmin](https://github.com/kinoaa/gifmin.js)
	- 不成熟的产品，只支持颜色压缩
- [ImageMagick](https://imagemagick.org/index.php)
	- GPL协议，图片编辑软件，处理速度不是很快，优点是对图片信息解析较为方便
- [gifsicle](https://www.lcdf.org/gifsicle/)
	- GPL协议，特点是处理速度快
- 对gifsicle的前端包装(只是包装，最后还是调用gifsicle本体)
	- [gifsicle-bin](https://github.com/imagemin/gifsicle-bin)
	- [imagemin-gifsicle](https://github.com/imagemin/imagemin-gifsicle)
- [gifsicle-wasm-browser](https://github.com/renzhezhilu/gifsicle-wasm-browser)
	- gifsicle的wasm格式，可以直接在浏览器中调用
- ## 参考
- 1 [gif压缩原理介绍](https://www.uisdc.com/gif-compression)
  id:: 64318733-1821-4858-8af9-02d207b298d7
- ## 相关链接
- https://cloud.tencent.com/developer/article/1004763
- [秒开率达90%：腾讯看点客户端 GIF 转视频优化方案](https://cloud.tencent.com/developer/article/1555426)